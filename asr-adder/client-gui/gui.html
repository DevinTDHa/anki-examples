<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASR Adder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .container {
      margin-top: 20px;
    }

    table {
      margin-top: 20px;
    }

    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
    }

    .recording {
      background-color: red;
      color: white;
    }

    .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    #recordBtn {
      width: 150px;
    }
  </style>
</head>

<body>
  <div class="container" style="max-width: 800px;">
    <h3>ASR Adder</h3>
    <p>This app will record audio when you press the button and send it to the cloze-wikt server to transcribe and
      extract wiktionary entries. The results can then be saved to a csv for further processing.</p>

    <!-- URL input -->
    <div class="input-group mb-3">
      <span class="input-group-text">URL</span>
      <input type="text" id="url" class="form-control" placeholder="http://localhost:5000/process_audio"
        onclick="autofillPlaceholder(this)">
      <button class="btn btn-primary" id="testBtn">Test</button>
      <!-- TODO: Maybe switch for max n-grams int?  -->
    </div>

    <!-- Record button and output text in same row -->
    <div class="row mb-3">
      <div class="col-auto">
        <button class="btn btn-primary" id="recordBtn">Record</button>
      </div>
      <div class="col">
        <input type="text" id="outputText" class="form-control" placeholder="Output text" disabled>
      </div>
    </div>

    <!-- Results Table wrapped in a proper row div -->
    <div class="row">
      <div class="col-12">
        <div class="table-wrapper", style="max-width: 700; max-height: none;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Word</th>
                <th>Definition</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="resultsTable">
              <!-- Rows will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Clear and Save As Buttons -->
    <div class="mt-3">
      <button class="btn btn-primary" id="saveBtn">Save as</button>
      <input type="text" id="saveFileName" class="form-control" placeholder="results.csv"
        onclick="autofillPlaceholder(this)" style="display: inline-block; width: auto;">
      <button class="btn btn-primary float-end" id="clearBtn">Clear All Entries</button>
    </div>
  </div>

  <script>
    // State
    let chunks = [];
    let mediaRecorder;
    let recordingInterval;
    let recordingTime = 0;

    function autofillPlaceholder(element) {
      if (!element.value) {
        element.value = element.placeholder;
      }
    }

    // Format time in MM:SS
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      return `${minutes}:${secs}`;
    }

    // Start recording
    document.getElementById('recordBtn').addEventListener('click', function () {
      const recordBtn = document.getElementById('recordBtn');

      // If it's in recording state, stop recording
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(recordingInterval);
        recordBtn.disabled = true;
        recordBtn.innerHTML = '<div class="spinner-border" role="status"></div>'; // Show spinner
        return;
      }

      // Start recording
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordingTime = 0;
        recordBtn.classList.add('recording');
        recordBtn.textContent = `Stop 00:00`;

        // Update the recording time every second
        recordingInterval = setInterval(() => {
          recordingTime++;
          recordBtn.textContent = `Stop ${formatTime(recordingTime)}`;
        }, 1000);

        mediaRecorder.ondataavailable = function (e) {
          chunks.push(e.data);
        };

        mediaRecorder.onstop = function () {
          const blob = new Blob(chunks, { type: 'audio/wav' });
          chunks = [];
          sendAudio(blob);
        };
      });
    });

    // Send recorded audio to the server
    function sendAudio(audioBlob) {
      const url = document.getElementById('url').value;
      const formData = new FormData();
      formData.append('audio', audioBlob, 'audio.wav');

      fetch(url, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          // Handle server response
          console.log('Success:', data);
          const outputText = data.transcription;
          document.getElementById('outputText').value = outputText;

          const resultsTable = document.getElementById('resultsTable');

          Object.entries(data.result).forEach(([word, definition]) => {
            const row = document.createElement('tr');

            const wordCell = document.createElement('td');
            wordCell.textContent = word;
            row.appendChild(wordCell);

            const definitionCell = document.createElement('td');
            definitionCell.textContent = definition.short; // TODO: save the rest of the def
            row.appendChild(definitionCell);

            const actionCell = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => row.remove());
            actionCell.appendChild(deleteBtn);
            row.appendChild(actionCell);

            resultsTable.appendChild(row);
          });

          // Reset button after response
          const recordBtn = document.getElementById('recordBtn');
          recordBtn.disabled = false;
          recordBtn.classList.remove('recording');
          recordBtn.textContent = 'Record';
        })
        .catch(error => {
          console.error('Error:', error);
          // Reset button even if there's an error
          const recordBtn = document.getElementById('recordBtn');
          recordBtn.disabled = false;
          recordBtn.classList.remove('recording');
          recordBtn.textContent = 'Record';
        });
    }

    // Clear the results table
    document.getElementById('clearBtn').addEventListener('click', function () {
      document.getElementById('resultsTable').innerHTML = '';
      document.getElementById('outputText').value = '';
    });

    // Save results to a file
    document.getElementById('saveBtn').addEventListener('click', function () {
      const resultsTable = document.getElementById('resultsTable');
      const fileName = document.getElementById('saveFileName').value || document.getElementById('saveFileName').placeholder;

      let fileContent = '';

      // TODO: Proper formatting here
      for (const row of resultsTable.rows) {
        const word = row.cells[0].textContent;
        const definition = row.cells[1].textContent;
        fileContent += `${word}\t${definition}\n`;
      }

      const blob = new Blob([fileContent], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    });

    // Test button placeholder
    document.getElementById('testBtn').addEventListener('click', function () {
      let url = document.getElementById('url').value;
      const baseUrl = new URL(url).origin; // Extract the base URL

      fetch(baseUrl)
        .then(response => {
          if (response.status === 200) {
            this.style.backgroundColor = 'green';
          } else {
            this.style.backgroundColor = 'red';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          this.style.backgroundColor = 'red';
        });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>